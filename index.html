<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Paradas de Conveyor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Librería para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Color de fondo más claro */
        }
        .tab-active {
            border-bottom-color: #0d9488; /* Verde azulado para la pestaña activa */
            color: #0d9488;
            font-weight: 600;
        }
        @keyframes blink {
            50% { opacity: 0.6; }
        }
        .blinking {
            animation: blink 1.5s linear infinite;
        }
        /* Estilos personalizados para un look más profesional */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #0d9488; /* Verde azulado */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0f766e;
        }
        .btn-start {
            background-color: #f59e0b; /* Ambar para iniciar */
        }
        .btn-start:hover {
            background-color: #d97706;
        }
        .btn-stop {
            background-color: #10b981; /* Verde esmeralda para detener */
        }
        .btn-stop:hover {
            background-color: #059669;
        }
        .status-running {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-stopped {
            background-color: #fffbeb;
            color: #b45309;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-10 text-center">
            <div class="inline-flex items-center justify-center gap-3">
                <!-- Icono alusivo a medical devices/etiquetado -->
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#0d9488" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-syringe"><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15 1"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/></svg>
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Monitor de Procesos de Etiquetado</h1>
                    <p class="text-gray-500 mt-1">Análisis de Paradas en Líneas de Dispositivos Médicos</p>
                </div>
            </div>
        </header>

        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
                <button id="tab-live" class="flex items-center gap-2 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Control en Vivo
                </button>
                <button id="tab-summary" class="flex items-center gap-2 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-8.1-4.3"/><path d="M13 17a6 6 0 0 0 8.1-4.3"/></svg>
                    Resumen y Análisis
                </button>
            </nav>
        </div>

        <main>
            <div id="live-view">
                <div class="mb-8 flex flex-col items-center justify-center space-y-2">
                    <label for="line-selector" class="text-lg font-medium text-gray-800">Monitorear Línea de Producción</label>
                    <select id="line-selector" class="block w-full max-w-xs pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md shadow-sm">
                        <option value="1">Línea 1</option><option value="2">Línea 2</option><option value="3">Línea 3</option><option value="4">Línea 4</option>
                    </select>
                </div>
                <div id="live-card-container" class="max-w-md mx-auto"></div>
            </div>

            <div id="summary-view" class="hidden">
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold mb-6">Historial y Análisis de Paradas</h2>
                    <div class="flex flex-wrap gap-4 items-end mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div>
                            <label for="filter-line" class="block text-sm font-medium text-gray-700">Línea</label>
                            <select id="filter-line" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                                <option value="all">Todas las Líneas</option><option value="1">Línea 1</option><option value="2">Línea 2</option><option value="3">Línea 3</option><option value="4">Línea 4</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-shift" class="block text-sm font-medium text-gray-700">Turno</label>
                            <select id="filter-shift" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                                <option value="all">Todos los Turnos</option>
                                <option value="Turno Regular">Turno Regular (8AM - 5PM)</option>
                                <option value="Horas Extras">Horas Extras (5PM - 9PM)</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-reason" class="block text-sm font-medium text-gray-700">Motivo</label>
                            <select id="filter-reason" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                                <option value="all">Todos los Motivos</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Desde</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Hasta</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                        </div>
                        <button id="apply-filters" class="btn-primary px-4 py-2 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Aplicar Filtros</button>
                        <button id="monthly-summary-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                            Analizar Mes Actual
                        </button>
                        <button id="export-excel" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Exportar a Excel
                        </button>
                        <button id="import-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Importar Historial
                        </button>
                    </div>

                    <div id="charts-view" class="mb-10">
                        <h3 class="text-xl font-semibold mb-6 text-center">Visualización de Datos</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-slate-50 p-4 rounded-lg h-96"><h4 class="text-lg font-medium text-center mb-2">Principales Motivos de Parada</h4><canvas id="reasonsChart"></canvas></div>
                            <div class="bg-slate-50 p-4 rounded-lg h-96"><h4 class="text-lg font-medium text-center mb-2">Impacto por Línea</h4><canvas id="linesChart"></canvas></div>
                        </div>
                        <div class="mt-8 bg-slate-50 p-4 rounded-lg h-96">
                            <h4 class="text-lg font-medium text-center mb-2">Comparativo Diario de Paradas (Tendencia)</h4>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4">Registro Detallado</h3>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Línea</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Turno</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inicio de Parada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fin de Parada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duración (mins)</th>
                        </tr></thead><tbody id="summary-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        <p id="no-summary-data" class="text-center py-8 text-gray-500 hidden">No hay datos de paradas para mostrar con los filtros seleccionados.</p>
                    </div>
                     <!-- Controles de Paginación -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-4">
                        <button id="prev-page" class="pagination-btn bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Anterior</button>
                        <span id="page-info" class="text-sm font-medium text-gray-700"></span>
                        <button id="next-page" class="pagination-btn bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700">Siguiente</button>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="error-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden">
            <div class="card p-8 max-w-sm w-full">
                <div class="flex items-center gap-3 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <h3 class="text-xl font-bold text-red-600">Error</h3>
                </div>
                <p id="error-message" class="text-gray-700 mb-6"></p>
                <button id="close-error-modal" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none">Cerrar</button>
            </div>
        </div>
        
        <!-- Modal de Seguridad -->
        <div id="security-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden">
            <div class="card p-8 max-w-sm w-full">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Acceso Restringido</h3>
                <p class="text-gray-600 mb-4">Por favor, ingrese el código de acceso para ver el resumen.</p>
                <input type="password" id="security-code-input" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2" placeholder="Código de 4 dígitos">
                <p id="security-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button id="verify-security-code" class="w-full btn-primary py-2 rounded-md">Verificar</button>
                <button id="close-security-modal" class="w-full mt-2 text-gray-600 hover:text-gray-800">Cancelar</button>
            </div>
        </div>

        <!-- Modal de Importación -->
        <div id="import-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden">
            <div class="card p-8 max-w-lg w-full">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Asistente de Importación de Datos</h3>
                <p class="text-gray-600 mb-4 text-sm">Siga las instrucciones para preparar sus datos. Luego, pegue aquí los datos copiados (sin los encabezados).</p>
                <textarea id="import-data-area" class="w-full h-40 p-2 border border-gray-300 rounded-md mb-2 font-mono text-xs" placeholder="Pegue aquí los datos de su hoja de cálculo..."></textarea>
                <div id="import-progress" class="hidden w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="import-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="import-status" class="text-sm text-gray-500 mb-4 h-5"></p>
                <div class="flex justify-end gap-4">
                    <button id="close-import-modal" class="text-gray-600 hover:text-gray-800">Cancelar</button>
                    <button id="start-import-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Iniciar Importación</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, serverTimestamp, query, where, getDocs, Timestamp, orderBy, limit, startAfter, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCPSaT7mS5HTb-rJS3FeSnFH4RNC8o8Mu8",
          authDomain: "supplemental-405ba.firebaseapp.com",
          projectId: "supplemental-405ba",
          storageBucket: "supplemental-405ba.firebasestorage.app",
          messagingSenderId: "700177290441",
          appId: "1:700177290441:web:e4b7cc9157b76e83892918"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const NUM_LINES = 4;
        const REASONS = ["Espera de producto por material con error en sistema", "Cambio de orden", "Falta de Inspector de calidad", "Espera de entrega de material", "Espera de entrega de material de otros lotes o ítems", "Espera de confirmación de pick", "Cambio de label", "Usuario AM expirado", "Cambio de ribbon", "Espera de aprobación del cliente", "Reunión operativa", "Ajuste de printer (información cortada)", "Espera de material (IFU)", "Espera de material (Labels)", "Espera de material (Inserts)", "Error en sistema por orden reservada por otro usuario", "Ajuste de printer (etiquetas ilegibles)", "Printer averiado (Reemplazo de componentes)", "Falta de personal para inicio de corrida", "Ajuste de printer (letras mal formadas)", "Ajuste de printer (ajustes de guía)", "Printer averiado (Cambio de Platen Roller)", "Ajuste de printer (Limpieza de Cabezal del printer)", "Reinicio del computador", "Actualización del computador", "Error en sistema JDE", "Error de lectura del Escaner", "Ajuste de Escaner", "Ajuste de printer (Ajuste de guía y limpieza de cabezal)", "Cambio de ribon y limpieza del printer", "Cambio de label y limpieza del printer", "Dispensador de tape averiado", "Dispensadora de labels averiada", "Ajuste de dispensadora de labels", "Ajuste de dispensador de tape", "Pick extraviado", "Ajuste de printer (información cortada)", "Ajuste de printer (Label atascado)", "Verificación de paleta por diferencia en el cuadre de labels", "Falta de personal", "Espera de colocar material en la línea", "Espera de tape", "Ajuste de printer (Etiquetas manchadas)", "Ajuste de parámetros del printer", "Espera de material handler", "Ajuste de printer (cambio de parámetros)", "Ajuste de printer (Limpieza de printer)"];
        const lineStates = [];
        let currentLineIndex = 0;
        let reasonsChartInstance = null;
        let linesChartInstance = null;
        let trendChartInstance = null;

        // Estado de paginación
        let currentPage = 1;
        const PAGE_SIZE = 25;
        let pageSnapshots = new Map();
        let totalPages = 1;
        let currentQueryConstraints = [];

        const liveView = document.getElementById('live-view');
        const summaryView = document.getElementById('summary-view');
        const tabLive = document.getElementById('tab-live');
        const tabSummary = document.getElementById('tab-summary');
        const summaryTableBody = document.getElementById('summary-table-body');
        const noSummaryData = document.getElementById('no-summary-data');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const monthlySummaryBtn = document.getElementById('monthly-summary-btn');
        const exportExcelBtn = document.getElementById('export-excel');
        const lineSelector = document.getElementById('line-selector');
        const liveCardContainer = document.getElementById('live-card-container');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeErrorModal = document.getElementById('close-error-modal');
        const filterReason = document.getElementById('filter-reason');
        const filterShift = document.getElementById('filter-shift');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const securityModal = document.getElementById('security-modal');
        const securityCodeInput = document.getElementById('security-code-input');
        const verifySecurityCodeBtn = document.getElementById('verify-security-code');
        const closeSecurityModalBtn = document.getElementById('close-security-modal');
        const securityError = document.getElementById('security-error');
        // Import elements
        const importBtn = document.getElementById('import-btn');
        const importModal = document.getElementById('import-modal');
        const closeImportModalBtn = document.getElementById('close-import-modal');
        const startImportBtn = document.getElementById('start-import-btn');
        const importDataArea = document.getElementById('import-data-area');
        const importProgress = document.getElementById('import-progress');
        const importProgressBar = document.getElementById('import-progress-bar');
        const importStatus = document.getElementById('import-status');


        // --- CÓDIGO DE SEGURIDAD ---
        // CAMBIA ESTE CÓDIGO POR UNO PERSONALIZADO DE 4 DÍGITOS
        const SUMMARY_ACCESS_CODE = "5555"; 
        let isSummaryUnlocked = false;

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        closeErrorModal.addEventListener('click', () => { errorModal.classList.add('hidden'); });
        
        function createLiveCard() {
            liveCardContainer.innerHTML = `
                <div id="live-card" class="card p-6 transition-all duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <h2 id="live-card-title" class="text-2xl font-bold text-gray-900"></h2>
                        <span id="live-card-status" class="px-3 py-1 text-sm font-semibold rounded-full"></span>
                    </div>
                    <div id="live-card-timer" class="text-center text-5xl font-mono my-8 text-gray-700">00:00:00</div>
                    <div class="mb-6"><select id="live-card-reason" disabled class="block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm"><option value="">-- Seleccione un motivo de parada --</option>${REASONS.map(r => `<option value="${r}">${r}</option>`).join('')}</select></div>
                    <button id="live-card-toggle-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg"></button>
                </div>`;
            document.getElementById('live-card-toggle-btn').addEventListener('click', handleToggleClick);
        }

        function updateLiveCardView() {
            const lineState = lineStates[currentLineIndex];
            if (!lineState) return;
            const lineNum = currentLineIndex + 1;
            const isStopped = lineState.isStopped;

            const card = document.getElementById('live-card');
            const titleEl = document.getElementById('live-card-title');
            const statusEl = document.getElementById('live-card-status');
            const timerEl = document.getElementById('live-card-timer');
            const reasonEl = document.getElementById('live-card-reason');
            const toggleBtn = document.getElementById('live-card-toggle-btn');
            
            titleEl.textContent = `Línea ${lineNum}`;

            if (isStopped) {
                card.classList.add('border', 'border-amber-300');
                statusEl.textContent = 'Detenido';
                statusEl.className = 'px-3 py-1 text-sm font-semibold rounded-full status-stopped blinking';
                timerEl.classList.add('text-amber-600');
                reasonEl.disabled = false;
                reasonEl.classList.remove('bg-gray-100');
                toggleBtn.textContent = 'Reanudar Línea';
                toggleBtn.className = 'w-full font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg btn-stop';
            } else {
                card.classList.remove('border', 'border-amber-300');
                statusEl.textContent = 'En Operación';
                statusEl.className = 'px-3 py-1 text-sm font-semibold rounded-full status-running';
                timerEl.classList.remove('text-amber-600');
                timerEl.textContent = '00:00:00';
                reasonEl.disabled = true;
                reasonEl.value = '';
                reasonEl.classList.add('bg-gray-100');
                toggleBtn.textContent = 'Iniciar Parada';
                toggleBtn.className = 'w-full font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg btn-start text-white';
            }
        }
        
        function handleToggleClick() {
            lineStates[currentLineIndex].isStopped ? endStop(currentLineIndex) : startStop(currentLineIndex);
        }

        lineSelector.addEventListener('change', (e) => {
            currentLineIndex = parseInt(e.target.value, 10) - 1;
            updateLiveCardView();
        });

        const formatTime = (seconds) => [Math.floor(seconds / 3600), Math.floor((seconds % 3600) / 60), seconds % 60].map(v => v.toString().padStart(2, '0')).join(':');
        
        function updateTimer(lineIndex) {
            const line = lineStates[lineIndex];
            if (line.isStopped && line.startTime) {
                const elapsedSeconds = Math.floor((new Date() - line.startTime) / 1000);
                if (lineIndex === currentLineIndex) {
                    document.getElementById('live-card-timer').textContent = formatTime(elapsedSeconds);
                }
            }
        }

        function getCurrentShift() {
            const hour = new Date().getHours();
            if (hour >= 8 && hour < 17) { // 8:00 AM to 4:59 PM
                return "Turno Regular";
            }
            if (hour >= 17 && hour < 21) { // 5:00 PM to 8:59 PM
                return "Horas Extras";
            }
            return null; // No shift assigned if outside defined hours
        }
        
        async function startStop(lineIndex) {
            try {
                const currentShift = getCurrentShift();
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/stops`), { 
                    lineId: lineIndex + 1, 
                    startTime: serverTimestamp(), 
                    endTime: null, 
                    reason: null,
                    shift: currentShift
                });
                lineStates[lineIndex] = { ...lineStates[lineIndex], isStopped: true, stopId: docRef.id, startTime: new Date(), timerInterval: setInterval(() => updateTimer(lineIndex), 1000) };
                updateLiveCardView();
            } catch (error) { console.error("Error al iniciar parada: ", error); showError("No se pudo registrar el inicio de la parada."); }
        }
        
        async function endStop(lineIndex) {
            const line = lineStates[lineIndex];
            const reason = document.getElementById('live-card-reason').value;
            if (!reason) { showError("Por favor, seleccione un motivo para la parada."); return; }
            if (!line.stopId) { showError("Error: No se encontró el ID de la parada activa."); return; }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/stops`, line.stopId), { endTime: serverTimestamp(), reason: reason });
                clearInterval(line.timerInterval);
                lineStates[lineIndex] = { isStopped: false, stopId: null, timerInterval: null, startTime: null };
                updateLiveCardView();
            } catch (error) { console.error("Error al detener parada: ", error); showError("No se pudo registrar el fin de la parada."); }
        }

        function switchTab(targetTab) {
            if (targetTab === 'summary') {
                summaryView.classList.remove('hidden'); liveView.classList.add('hidden');
                tabSummary.classList.add('tab-active'); tabLive.classList.remove('tab-active');
                applyFiltersAndFetch();
            } else {
                liveView.classList.remove('hidden'); summaryView.classList.add('hidden');
                tabLive.classList.add('tab-active'); tabSummary.classList.remove('tab-active');
            }
        }
        
        tabLive.addEventListener('click', () => switchTab('live'));
        tabSummary.addEventListener('click', () => {
            if (isSummaryUnlocked) {
                switchTab('summary');
            } else {
                securityModal.classList.remove('hidden');
                securityCodeInput.focus();
            }
        });
        
        verifySecurityCodeBtn.addEventListener('click', () => {
            if (securityCodeInput.value === SUMMARY_ACCESS_CODE) {
                isSummaryUnlocked = true;
                securityError.textContent = '';
                securityCodeInput.value = '';
                securityModal.classList.add('hidden');
                switchTab('summary');
            } else {
                securityError.textContent = 'Código incorrecto. Inténtelo de nuevo.';
                securityCodeInput.value = '';
                securityCodeInput.focus();
            }
        });

        closeSecurityModalBtn.addEventListener('click', () => {
            securityError.textContent = '';
            securityCodeInput.value = '';
            securityModal.classList.add('hidden');
        });

        securityCodeInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                verifySecurityCodeBtn.click();
            }
        });

        async function applyFiltersAndFetch() {
            currentPage = 1;
            pageSnapshots.clear();

            const lineFilter = document.getElementById('filter-line').value;
            const shiftFilter = document.getElementById('filter-shift').value;
            const reasonFilter = document.getElementById('filter-reason').value;
            const startDateFilter = document.getElementById('filter-start-date').value;
            const endDateFilter = document.getElementById('filter-end-date').value;

            const constraints = [orderBy("startTime", "desc")];
            if (lineFilter !== 'all') constraints.push(where("lineId", "==", parseInt(lineFilter, 10)));
            if (shiftFilter !== 'all') constraints.push(where("shift", "==", shiftFilter));
            if (reasonFilter !== 'all') constraints.push(where("reason", "==", reasonFilter));
            if (startDateFilter) {
                const parts = startDateFilter.split('-');
                const start = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                constraints.push(where("startTime", ">=", Timestamp.fromDate(start)));
            }
            if (endDateFilter) { 
                const parts = endDateFilter.split('-');
                const end = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999));
                constraints.push(where("startTime", "<=", Timestamp.fromDate(end))); 
            }
            currentQueryConstraints = constraints;

            try {
                const countQuery = query(collection(db, `artifacts/${appId}/public/data/stops`), ...constraints.filter(c => c.type !== 'orderBy'));
                const countSnapshot = await getCountFromServer(countQuery);
                const totalStops = countSnapshot.data().count;
                totalPages = Math.ceil(totalStops / PAGE_SIZE) || 1;
                fetchPage();
            } catch(error) {
                console.error("Error fetching summary data:", error);
                showError("No se pudo cargar el resumen de paradas. Es posible que necesite crear un índice en Firebase. Revise la consola del navegador (F12) para obtener un enlace directo y crearlo.");
            }
        }

        async function fetchPage() {
            try {
                let pageQuery;
                const baseQuery = query(collection(db, `artifacts/${appId}/public/data/stops`), ...currentQueryConstraints);

                if (currentPage > 1 && pageSnapshots.has(currentPage - 1)) {
                    pageQuery = query(baseQuery, startAfter(pageSnapshots.get(currentPage - 1)), limit(PAGE_SIZE));
                } else {
                    pageQuery = query(baseQuery, limit(PAGE_SIZE));
                }
                
                const querySnapshot = await getDocs(pageQuery);
                
                if (!querySnapshot.empty) {
                    const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    pageSnapshots.set(currentPage, lastDoc);
                }
                
                const allStops = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderSummaryTable(allStops);
                fetchAllFilteredDataForCharts();
                updatePaginationUI();
            } catch(error) {
                 console.error("Error fetching page data:", error);
                 showError("No se pudo cargar la página. Es posible que falte un índice en Firebase.");
            }
        }
        
        async function fetchAllFilteredDataForCharts() {
            try {
                const fullQuery = query(collection(db, `artifacts/${appId}/public/data/stops`), ...currentQueryConstraints);
                const querySnapshot = await getDocs(fullQuery);
                const allStops = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCharts(allStops);
            } catch (error) {
                console.error("Error fetching full data for charts:", error);
            }
        }

        function updatePaginationUI() {
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            document.getElementById('pagination-controls').classList.toggle('hidden', totalPages <= 1);
        }

        function renderSummaryTable(stops) {
            const completedStops = stops.filter(s => s.startTime && s.endTime);
            noSummaryData.classList.toggle('hidden', completedStops.length > 0);
            summaryTableBody.innerHTML = completedStops.map(stop => {
                const durationMinutes = ((stop.endTime.toDate() - stop.startTime.toDate()) / 60000).toFixed(2);
                return `<tr>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Línea ${stop.lineId}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${stop.shift || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-800">${stop.reason || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stop.startTime.toDate().toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stop.endTime.toDate().toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${durationMinutes}</td>
                </tr>`;
            }).join('');
        }
        
        function renderCharts(stops) {
            if (reasonsChartInstance) reasonsChartInstance.destroy();
            if (linesChartInstance) linesChartInstance.destroy();
            if (trendChartInstance) trendChartInstance.destroy();

            const completedStops = stops.filter(s => s.startTime && s.endTime);
            
            const reasonsData = completedStops.reduce((acc, stop) => {
                const duration = (stop.endTime.toDate() - stop.startTime.toDate()) / 60000;
                const reason = stop.reason || 'Sin Motivo';
                acc[reason] = (acc[reason] || 0) + duration;
                return acc;
            }, {});
            
            const sortedReasons = Object.entries(reasonsData).sort(([, a], [, b]) => b - a).slice(0, 10);
            
            const linesData = completedStops.reduce((acc, stop) => {
                const duration = (stop.endTime.toDate() - stop.startTime.toDate()) / 60000;
                acc[stop.lineId] = (acc[stop.lineId] || 0) + duration;
                return acc;
            }, {});

            const dailyData = completedStops.reduce((acc, stop) => {
                const date = stop.startTime.toDate().toISOString().slice(0, 10);
                const duration = (stop.endTime.toDate() - stop.startTime.toDate()) / 60000;
                acc[date] = (acc[date] || 0) + duration;
                return acc;
            }, {});

            const sortedDays = Object.entries(dailyData).sort(([a], [b]) => a.localeCompare(b));

            reasonsChartInstance = new Chart(document.getElementById('reasonsChart'), {
                type: 'bar',
                data: { labels: sortedReasons.map(r => r[0]), datasets: [{ label: 'Minutos Totales', data: sortedReasons.map(r => r[1].toFixed(2)), backgroundColor: '#0d9488' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            linesChartInstance = new Chart(document.getElementById('linesChart'), {
                type: 'pie',
                data: { labels: Object.keys(linesData).map(l => `Línea ${l}`), datasets: [{ data: Object.values(linesData).map(v => v.toFixed(2)), backgroundColor: ['#14b8a6', '#f59e0b', '#64748b', '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            trendChartInstance = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedDays.map(d => d[0]),
                    datasets: [{
                        label: 'Minutos Totales de Parada por Día',
                        data: sortedDays.map(d => d[1].toFixed(2)),
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutos de Parada' }
                        }
                    }
                }
            });
        }
        
        async function exportToExcel() {
            showError("Generando reporte completo... Esto puede tardar unos segundos.");

            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/stops`), ...currentQueryConstraints);
                const querySnapshot = await getDocs(q);
                const allStops = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const completedStops = allStops.filter(s => s.startTime && s.endTime);

                if (completedStops.length === 0) {
                    showError("No hay datos para exportar con los filtros seleccionados.");
                    return;
                }

                const data = completedStops.map(stop => ({
                    "Línea": stop.lineId,
                    "Turno": stop.shift || 'N/A',
                    "Motivo": stop.reason || 'N/A',
                    "Inicio de Parada": stop.startTime.toDate().toLocaleString(),
                    "Fin de Parada": stop.endTime.toDate().toLocaleString(),
                    "Duración (mins)": parseFloat(((stop.endTime.toDate() - stop.startTime.toDate()) / 60000).toFixed(2))
                }));

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Resumen de Paradas");

                const today = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(workbook, `Resumen_Paradas_${today}.xlsx`);
                
                document.getElementById('error-modal').classList.add('hidden');

            } catch (error) {
                 console.error("Error exporting to Excel:", error);
                 showError("No se pudo generar el reporte de Excel. Inténtelo de nuevo.");
            }
        }
        
        function populateReasonFilter() {
            REASONS.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                filterReason.appendChild(option);
            });
        }

        function generateMonthlySummary() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            const formatDate = (date) => date.toISOString().slice(0, 10);

            document.getElementById('filter-start-date').value = formatDate(firstDay);
            document.getElementById('filter-end-date').value = formatDate(lastDay);

            applyFiltersAndFetch();
        }

        applyFiltersBtn.addEventListener('click', applyFiltersAndFetch);
        monthlySummaryBtn.addEventListener('click', generateMonthlySummary);
        exportExcelBtn.addEventListener('click', exportToExcel);
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchPage();
            }
        });
        nextPageBtn.addEventListener('click', () => {
             if (currentPage < totalPages) {
                currentPage++;
                fetchPage();
            }
        });

        async function initialize() {
            populateReasonFilter();
            for (let i = 0; i < NUM_LINES; i++) lineStates.push({ isStopped: false, stopId: null, timerInterval: null, startTime: null });
            createLiveCard();
            updateLiveCardView();
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                if (error.code === 'auth/configuration-not-found') {
                    showError("Error de Configuración: El método de 'Inicio de sesión anónimo' no está habilitado en tu proyecto de Firebase. Por favor, ve a la sección 'Authentication' -> 'Sign-in method' en tu consola de Firebase y actívalo.");
                } else {
                    showError("No se pudo autenticar. La aplicación podría no funcionar correctamente.");
                }
            }
        }

        initialize();
    </script>
</body>
</html>

